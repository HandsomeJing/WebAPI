# 经销商平台后端面试速记（可背诵版）

> 目的：面向面试官快速清晰地讲解本项目后端的架构、流程与实现细节；关键词均可点击跳转到对应源码文件，便于平时复习与现场答疑。

---

## 1 分钟总述（背诵版）

- 我们做的是“经销商平台”，核心闭环是：商品 → 购物车 → 下单 → 订单详情/再次购买/取消。
- 后端基于 ASP.NET Core + EF Core + AutoMapper，配合 Repository 模式，Redis 做购物车与商品缓存，JWT 做认证，统一授权过滤器把客户号注入到 HttpContext。
- 订单详情在服务层聚合：补齐仓库信息、统计件数金额、拉取发票抬头，并通过本地事件总线在服务间解耦。
- “再次购买”不会生成新订单，而是把历史订单商品回填购物车；“取消订单”会删除主/明细/进度并清空购物车。

---

## 架构与技术栈

- Web API：ASP.NET Core 9（JWT/CORS/Swagger）。
- 数据访问：EF Core（Repository 模式，事务用 TransactionScope）。
- 缓存与会话：Redis（购物车 Hash 存储，商品/图片缓存，健壮性保护）。
- 映射：AutoMapper（DTO 与实体映射），详见 [DearlerPlatformProfile.cs](../DearlerPlatform.Service/DearlerPlatformProfile.cs)。
- 领域实体：见 [DearlerPlatform.Domain](../DearlerPlatform.Domain)。
- 基础设施：本地事件总线 [LocalEventBus](../DearlerPlatform.Common/EventBusHelper/LocalEventBus.cs)；Redis 封装 [IRedisWorker](../DearlerPlatform.Common/RedisModule/IRedisWorker.cs)。

---

## 关键控制器（入口与协议）

- 订单确认控制器：[OrderConfirmController](../DearlerPlatform.Api/Controllers/OrderConfirmController.cs)
  - GET /api/OrderConfirm：拉取已选购物车项目。
  - GET /api/OrderConfirm/LatestOrderNo：获取该用户最近订单号（前端下单成功后跳转详情用）。
  - POST /api/OrderConfirm：提交订单（生成主/明细/流程、清理购物车）。
- 订单信息控制器：[OrderInfoController](../DearlerPlatform.Api/Controllers/OrderInfoController.cs)
  - GET /api/OrderInfo?orderNo=...：获取订单详情（统计件数/金额、仓库信息、发票抬头）。
  - GET /api/OrderInfo/BuyAgain?saleOrderNo=...：再次购买（把历史订单商品回填购物车）。
  - POST /api/OrderInfo/Cancel?saleOrderNo=...：取消订单（删主/明细/进度并清空购物车）。
  - GET /api/OrderInfo/List?take=N：订单列表（最近 N 条，用于“我的订单”页面）。
- 购物车控制器：[ShoppingCartController](../DearlerPlatform.Api/Controllers/ShoppingCartController.cs)
- 客户控制器（获取发票抬头）：[CustomerController](../DearlerPlatform.Api/Controllers/CustomerController.cs)

授权与用户上下文：

- 认证：JWT；跨域：CORS；
- 授权过滤器注入客户号：[CtmAuthorizationFilterAttribute](../DearlerPlatform.Api/Filters/CtmAuthorizationFilterAttribute.cs) → 在 HttpContext.Items["CUSTOMER_NO"] 提供 customerNo。

---

## 服务层职责与关键方法

- 订单服务（聚合与业务中枢）：[OrderService.cs](../DearlerPlatform.Service/OrderApp/OrderService.cs)
  - GetOrderInfoByOrderNo：拼装订单详情；统计件数/金额；回填仓库信息；拉取发票抬头；（当前按需求固定显示：西安仓库/井水田/17765006056）。
  - BuyAgain：把历史订单明细以 Hash 写回 Redis 购物车，勾选并带上数量。
  - CancelOrder：事务删除主/明细/进度，随后清空该客户购物车键 `cart:*:{customerNo}`。
  - GetLatestOrderNo / GetOrdersByCustomer：用于前端跳转详情与“我的订单”列表。
- 下单实现（分部文件）：
  - 新增主单/流程/明细：[OrderService.OrderMaster.cs](../DearlerPlatform.Service/OrderApp/OrderService.OrderMaster.cs)
  - 写入明细与价格来源：[OrderService.OrderDetail.cs](../DearlerPlatform.Service/OrderApp/OrderService.OrderDetail.cs)
  - 订单进度（示例“下单”步骤）：[OrderService.OrderProgress.cs](../DearlerPlatform.Service/OrderApp/OrderService.OrderProgress.cs)
- 购物车应用服务： [ShoppingCartAppService](../DearlerPlatform.Service/ShoppingCartApp/ShoppingCartAppService.cs)
  - 读写 Redis Hash：键格式 `cart:{CartGuid}:{CustomerNo}`，聚合读取 `cart:*:{CustomerNo}`。
- 商品服务（注入购物车商品详情）：[ProductService](../DearlerPlatform.Service/ProductApp/ProductService.cs)
  - 通过本地事件总线把 ProductDto 注入购物车 DTO，兜底补齐图片与售价。
- 客户服务（发票抬头）：[CustomerService](../DearlerPlatform.Service/CustomerApp/CustomerService.cs) + [CustomerService.Invoice.cs](../DearlerPlatform.Service/CustomerApp/CustomerService.Invoice.cs)
  - 负责把发票抬头注入订单详情 DTO（解决“开票人”显示与中文问题）。

接口定义（中文注释齐备）：[IOrderService](../DearlerPlatform.Service/OrderApp/IOrderService.cs)

---

## 数据访问与实体映射

- DbContext 与 Fluent 映射：[DearlerPlatformDbContext.cs](../DearlerPlatform.Core/Core/DearlerPlatformDbContext.cs)
  - 重点：`SaleOrderMaster.InvoiceNo`、`CustomerInvoice.InvoiceNo` 使用 `IsUnicode()`，避免中文抬头出现 “????”。
  - `Stock.StockName/StockLinkman` 也使用 Unicode；`SaleOrderProgress.StepName` 使用 Unicode。
- 领域对象索引：
  - 订单主/明细/进度：[SaleOrderMaster](../DearlerPlatform.Domain/SaleOrderMaster.cs) / [SaleOrderDetail](../DearlerPlatform.Domain/SaleOrderDetail.cs) / [SaleOrderProgress](../DearlerPlatform.Domain/SaleOrderProgress.cs)
  - 商品与销售配置：[Product](../DearlerPlatform.Domain/Product.cs) / [ProductSale](../DearlerPlatform.Domain/ProductSale.cs) / [ProductPhoto](../DearlerPlatform.Domain/ProductPhoto.cs)
  - 仓库与客户：[Stock](../DearlerPlatform.Domain/Stock.cs) / [Customer](../DearlerPlatform.Domain/Customer.cs) / [CustomerInvoice](../DearlerPlatform.Domain/CustomerInvoice.cs)

---

## Redis 缓存与购物车

- 封装接口与实现：[IRedisWorker](../DearlerPlatform.Common/RedisModule/IRedisWorker.cs) / [RedisWorker](../DearlerPlatform.Common/RedisModule/RedisWorker.cs)
  - 常用：`GetHashMemory<T>()`、`SetHashMemory<T>()`、`GetKeys()`、`RemoveKey()`。
- 购物车键约定：
  - 单条：`cart:{CartGuid}:{CustomerNo}`；聚合扫描：`cart:*:{CustomerNo}`。
  - 再次购买：为每条历史明细生成新 `CartGuid` 写回 Redis 并默认勾选。

---

## 订单流程串讲（面试高频）

1. 下单（POST /api/OrderConfirm）：

- 写主单（发票、备注、交货日期、仓库）、写“下单”进度、写明细（单价来自 ProductSale），成功后清理被选中的购物车键。
- 代码：
  - [OrderService.OrderMaster.cs](../DearlerPlatform.Service/OrderApp/OrderService.OrderMaster.cs)
  - [OrderService.OrderDetail.cs](../DearlerPlatform.Service/OrderApp/OrderService.OrderDetail.cs)

2. 订单详情（GET /api/OrderInfo）：

- 聚合明细与进度，计算件数与总价；若主单缺仓库号，按第一条商品的 ProductSale 补齐；再查 Stock 并显示（当前按需求固定展示为“西安仓库/井水田/17765006056”）。
- 触发事件总线拉取发票抬头，解决“开票人”中文显示。

3. 再次购买（GET /api/OrderInfo/BuyAgain）：

- 不生成新订单，直接把历史订单明细加入购物车（数量同步）。

4. 取消订单（POST /api/OrderInfo/Cancel）：

- 事务删除主/明细/进度，随后清空该客户所有购物车键。

---

## 安全与授权

- 登录发 Token，前端携带；API 用 JWT 验证。
- 统一授权过滤器读取 Token 并把客户号放入 HttpContext，所有控制器/服务都从这里取得 customerNo。
- 代码： [Filters/CtmAuthorizationFilterAttribute](../DearlerPlatform.Api/Filters/CtmAuthorizationFilterAttribute.cs)

---

## 常见问答（准备面）

- Q：为什么“开票人”之前是“????”？
  - A：数据库映射使用了非 Unicode。已把 `SaleOrderMaster.InvoiceNo` 和 `CustomerInvoice.InvoiceNo` 改为 `IsUnicode()`，新数据正常；历史数据需重写或更新。
- Q：“再次购买”为何不直接复制订单？
  - A：业务希望回到“购物车二次确认”，所以是把历史明细回填购物车，避免误生成新单。
- Q：取消订单如何保证一致性？
  - A：使用 `TransactionScope` 原子删除主/明细/进度，再清空 Redis 购物车键。
- Q：仓库信息为何固定展示？
  - A：按现阶段需求统一展示“西安仓库/井水田/17765006056”，可后续改为配置/表驱动。

---

## 本地运行与调试（后端）

- 任务：VS Code 任务栏有 build/watch/publish（.vscode 任务或 workspace tasks）。
- 连接：README 与 docker-compose 提供 SQL Server 与 Redis 的本地环境。
- 调试：Swagger/REST Client/前端代理到 7032 端口，注意携带 Token。

---

## 代码导航索引（点击直达）

- 控制器：
  - [OrderConfirmController](../DearlerPlatform.Api/Controllers/OrderConfirmController.cs)
  - [OrderInfoController](../DearlerPlatform.Api/Controllers/OrderInfoController.cs)
  - [ShoppingCartController](../DearlerPlatform.Api/Controllers/ShoppingCartController.cs)
  - [CustomerController](../DearlerPlatform.Api/Controllers/CustomerController.cs)
  - [ProductController](../DearlerPlatform.Api/Controllers/ProductController.cs)
- 服务：
  - [OrderService.cs](../DearlerPlatform.Service/OrderApp/OrderService.cs)
  - [OrderService.OrderMaster.cs](../DearlerPlatform.Service/OrderApp/OrderService.OrderMaster.cs)
  - [OrderService.OrderDetail.cs](../DearlerPlatform.Service/OrderApp/OrderService.OrderDetail.cs)
  - [OrderService.OrderProgress.cs](../DearlerPlatform.Service/OrderApp/OrderService.OrderProgress.cs)
  - [ShoppingCartAppService.cs](../DearlerPlatform.Service/ShoppingCartApp/ShoppingCartAppService.cs)
  - [ProductService.cs](../DearlerPlatform.Service/ProductApp/ProductService.cs)
  - [CustomerService.cs](../DearlerPlatform.Service/CustomerApp/CustomerService.cs)
  - [CustomerService.Invoice.cs](../DearlerPlatform.Service/CustomerApp/CustomerService.Invoice.cs)
  - [IOrderService.cs](../DearlerPlatform.Service/OrderApp/IOrderService.cs)
- 基础设施：
  - [DearlerPlatformDbContext](../DearlerPlatform.Core/Core/DearlerPlatformDbContext.cs)
  - [LocalEventBus](../DearlerPlatform.Common/EventBusHelper/LocalEventBus.cs)
  - [IRedisWorker](../DearlerPlatform.Common/RedisModule/IRedisWorker.cs)
  - [RedisWorker](../DearlerPlatform.Common/RedisModule/RedisWorker.cs)

---

## 复述模板（30 秒～2 分钟可自由组合）

- 项目一句话：后端基于 ASP.NET Core + EF Core + Redis，完成商品-购物车-下单-订单详情闭环，认证用 JWT，购物车与商品缓存用 Redis。
- 核心亮点：
  1) 订单详情服务端聚合，统计与仓库信息兜底，事件总线解耦“发票抬头”查询。
  2) “再次购买”回填购物车、取消订单事务+Redis 清理，保证一致性与体验。
  3) 编码细节：中文字段 Unicode 映射、防止“????”。

> 使用方式：在 VS Code 里打开此文档，直接点击文件链接即可跳转到对应源码。
